<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstudoFlow | Gest√£o Completa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4f46e5; --sidebar: #0f172a; --bg: #f1f5f9; --text: #1e293b; --muted: #64748b; --success: #10b981; --danger: #ef4444; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

        /* SIDEBAR PONTO 2 */
        nav { width: 280px; background: var(--sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; padding: 30px 20px; }
        .logo { font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-group { margin-bottom: 30px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: #475569; margin-bottom: 15px; display: block; font-weight: 700; letter-spacing: 1px; }
        .nav-item { padding: 12px 16px; border-radius: 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; color: #94a3b8; text-decoration: none; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        main { margin-left: 280px; padding: 40px; width: 100%; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 380px; gap: 30px; }
        .card { background: var(--white); border-radius: 20px; padding: 25px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* LISTA V13 */
        .rev-item { background: #fff; padding: 18px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .subject-tag { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 6px; background: #eef2ff; color: var(--primary); }
        
        /* BOT√ïES */
        .btn-save { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .actions { display: flex; gap: 8px; }
        .btn-circle { width: 38px; height: 38px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-check { background: #dcfce7; color: #15803d; }
        .btn-del { background: #fee2e2; color: #b91c1c; }

        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin: 8px 0 16px; font-family: inherit; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">üöÄ EstudoFlow</div>
        <div class="nav-group">
            <span class="nav-label">Dashboard</span>
            <div class="nav-item active" onclick="showSection('dashboard', this)">üè† Painel Principal</div>
            <div class="nav-item" onclick="showSection('relatorios', this)">üìä Relat√≥rios</div>
            <div class="nav-item" onclick="showSection('calendario', this)">üìÖ Calend√°rio</div>
        </div>
        <div class="nav-group">
            <span class="nav-label">Gest√£o</span>
            <div class="nav-item" onclick="showSection('materias', this)">üìö Mat√©rias</div>
        </div>
    </nav>

    <main>
        <div id="dashboard" class="section active">
            <h1 style="margin-bottom: 30px;">Dashboard</h1>
            <div class="dashboard-grid">
                <div class="left">
                    <div id="lista-revisoes"></div>
                </div>
                <div class="right">
                    <div class="card">
                        <h3>‚ûï Agendar Revis√£o</h3>
                        <label>Mat√©ria</label><input type="text" id="mat">
                        <label>T√≥pico</label><input type="text" id="top">
                        <label>Ciclo</label>
                        <select id="ciclo">
                            <option value="1">24 Horas</option>
                            <option value="7">7 Dias</option>
                            <option value="30">30 Dias</option>
                        </select>
                        <button class="btn-save" onclick="salvar()">Salvar no Banco</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="relatorios" class="section">
            <h1>Relat√≥rios de Desempenho</h1>
            <div class="card" style="margin-top:20px; max-width: 600px;">
                <canvas id="meuGrafico"></canvas>
            </div>
        </div>

        <div id="calendario" class="section">
            <h1>Calend√°rio de Vencimentos</h1>
            <div id="lista-calendario" style="margin-top: 20px;"></div>
        </div>

        <div id="materias" class="section">
            <h1>Minhas Mat√©rias</h1>
            <div id="grid-materias" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;"></div>
        </div>
    </main>

    <script>
        let db = [];
        let chartInstance = null;

        function showSection(id, element) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            element.classList.add('active');
            if(id === 'relatorios') atualizarGrafico();
            if(id === 'calendario') renderCalendario();
            if(id === 'materias') renderMaterias();
        }

        async function carregar() {
            const res = await fetch('/api/estudos');
            db = await res.json();
            renderDashboard();
        }

        function renderDashboard() {
            const cont = document.getElementById('lista-revisoes');
            cont.innerHTML = '';
            db.filter(i => !i.feito).forEach(i => {
                cont.innerHTML += `<div class="rev-item">
                    <div><span class="subject-tag">${i.materia}</span><br><strong>${i.subtopico}</strong></div>
                    <div class="actions">
                        <button class="btn-circle btn-check" onclick="concluir(${i.id})">‚úì</button>
                        <button class="btn-circle btn-del" onclick="excluir(${i.id})">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
        }

        function renderCalendario() {
            const cont = document.getElementById('lista-calendario');
            cont.innerHTML = '';
            // Ordenar por data
            const ordenados = [...db].sort((a,b) => a.data.localeCompare(b.data));
            ordenados.forEach(i => {
                const status = i.feito ? '‚úÖ Conclu√≠do' : '‚è≥ Pendente';
                cont.innerHTML += `<div class="card"><strong>${i.data}</strong> - ${i.materia}: ${i.subtopico} (${status})</div>`;
            });
        }

        function renderMaterias() {
            const cont = document.getElementById('grid-materias');
            cont.innerHTML = '';
            const materias = [...new Set(db.map(i => i.materia))];
            materias.forEach(m => {
                const qtd = db.filter(i => i.materia === m).length;
                cont.innerHTML += `<div class="card" style="text-align:center"><h3>${m}</h3><p>${qtd} t√≥picos</p></div>`;
            });
        }

        function atualizarGrafico() {
            const concluidos = db.filter(i => i.feito).length;
            const pendentes = db.filter(i => !i.feito).length;
            const ctx = document.getElementById('meuGrafico').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Conclu√≠dos', 'Pendentes'],
                    datasets: [{ data: [concluidos, pendentes], backgroundColor: ['#10b981', '#4f46e5'] }]
                }
            });
        }

        async function salvar() {
            const materia = document.getElementById('mat').value;
            const subtopico = document.getElementById('top').value;
            const dias = parseInt(document.getElementById('ciclo').value);
            const d = new Date(); d.setDate(d.getDate() + dias);
            await fetch('/api/estudos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ materia, subtopico, data: d.toLocaleDateString('pt-BR') })
            });
            carregar();
        }

        async function concluir(id) {
            await fetch(`/api/estudos/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ feito: true }) });
            carregar();
        }

        async function excluir(id) {
            if(confirm("Excluir?")) { await fetch(`/api/estudos/${id}`, { method: 'DELETE' }); carregar(); }
        }

        carregar();
    </script>
</body>
</html>
